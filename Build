# ! /bin/bash
# ---------------------------------------------------------------------------
# CppAD: C++ Algorithmic Differentiation: Copyright (C) 2003-06 Bradley M. Bell
# 
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
# ---------------------------------------------------------------------------
#
# Bash script for building the CppAD distribution.
#
# Default values used for arguments to configure during this script.
# These defaults are development system dependent and can be changed.
ADOLC_DIR=$HOME/adolc_base
FADBAD_DIR=$HOME
BOOST_DIR=/usr/include/boost-1_33
#
# date currently in configure.ac
AcDate=`grep "^ *AC_INIT(" configure.ac | \
	sed -e "s/.*, *\([0-9][0-9]-[0-9][0-9]-[0-9][0-9]\) *,.*/\1/"`
#
# version
#
if [ "$1" = "version" ] || [ "$1" = "all" ]
then
	#
	# Today's date in yy-mm-dd decimal digit format with leading zeros
	Today=`date +%g-%m-%d`
	#
	sed configure.ac > configure.tmp -e \
	"s/(CppAD, [0-9][0-9]-[0-9][0-9]-[0-9][0-9],/(CppAD, $Today,/"
	#
	diff configure.ac  configure.tmp
	mv   configure.tmp configure.ac
	#
	# change Autoconf date to today
	AcDate=$Today
	#
	for name in Doc omh/InstallUnix omh/InstallWindows
	do
		sed $name.omh > $name.tmp \
	-e "s/\([^0-9]\)[0-9][0-9]-[0-9][0-9]-[0-9][0-9]$/\1$Today/g" \
	-e "s/\([^0-9]\)[0-9][0-9]-[0-9][0-9]-[0-9][0-9]\([^0-9]\)/\1$Today\2/g" 
	#
		diff $name.omh $name.tmp
		mv   $name.tmp $name.omh
	done
	#
	# configure file is out of date so remove it
	if [ -e configure ]
	then
		rm configure
	fi
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
#
# automake
#
if [ "$1" = "automake" ] || [ "$1" = "all" ]
then
	if [ -e configure ]
	then
		rm configure
	fi
	echo "---------------------------------------------------------"
	echo "If aclocal generates warning messages, try running ./FixAclocal"
	echo "aclocal"
	aclocal
	echo "---------------------------------------------------------"
	#
	echo "autoheader"
	autoheader
	#
	echo "autoconf"
	autoconf
	#
	echo "automake -add-missing"
	automake --add-missing
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
#
# configure
#
if [ "$1" = "configure" ] || [ "$1" = "all" ]
then
	#
	TEST="--with-GetStarted --with-Introduction"
	if [ "$2" == "test" ]
	then
		TEST="$TEST --with-Example"
		TEST="$TEST --with-TestMore"
		TEST="$TEST --with-Speed"
		TEST="$TEST --with-PrintFor"
		TEST="$TEST --with-SpeedExample"
		TEST="$TEST --with-profiling"
		if [ -e $ADOLC_DIR/include/adolc ]
		then
			TEST="$TEST ADOLC_DIR=$ADOLC_DIR"
		fi
		if [ -e $FADBAD_DIR/FADBAD++ ]
		then
			TEST="$TEST FADBAD_DIR=$FADBAD_DIR"
		fi
		if [ -e $BOOST_DIR/boost ]
		then
			TEST="$TEST BOOST_DIR=$BOOST_DIR"
		fi
	fi
	#
	echo "configure \\"
	echo "  $TEST   \\"
	echo "	CPP_ERROR_WARN=\"-Wall -ansi -pedantic-errors -std=c++98\""
	#
	./configure \
		$TEST   \
		CPP_ERROR_WARN="-Wall -ansi -pedantic-errors -std=c++98"
	#
	# Fix Makefile for what appears to be a bug in gzip under cygwin
	echo "FixMakefile"
	./FixMakefile
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
#
# make
#
if [ "$1" = "make" ] || [ "$1" = "all" ]
then
	echo "make"
	make
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
#
# omhelp
#
if [ "$1" = "omhelp" ] || [ "$1" = "all" ]
then
	echo "RunOMhelp Dev"
	if ! ./RunOMhelp Dev
	then
		exit 1
	fi
	#
	echo "RunOMhelp Doc"
	if ! ./RunOMhelp Doc
	then
		exit 1
	fi
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
#
# dist
#
if [ "$1" = "dist" ] || [ "$1" = "all" ]
then
	#
	if [ -e cppad-$AcDate ]
	then
		echo "rm -f -r cppad-$AcDate"
		rm -f -r cppad-$AcDate
	fi
	for file in CppAD-*.tar.gz CppAD-*.zip
	do
		if [ -e $file ]
		then
			echo "rm $file"
			rm $file
		fi
	done
	#
	echo "make dist"
	make dist
	#
	if [ ! -e cppad-$AcDate.tar.gz ]
	then
		echo "cppad-$AcDate.tar.gz does not exist"
		echo "perhaps version is out of date"
		#
		exit 1
	fi
	# create the unix version by changing cppad to upper case
	# (use temporary file to avoid error on rename in Cygwin case)
	mv cppad-$AcDate.tar.gz CppAD-$AcDate.tmp
	mv CppAD-$AcDate.tmp    CppAD-$AcDate.tar.gz
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
if [ "$1" = "dos" ] || ( [ "$1" = "all" ] && [ "$2" != "unix" ] )
then
	#
	if [ -e cppad-$AcDate ]
	then
		echo "rm -f -r cppad-$AcDate"
		rm -f -r cppad-$AcDate
	fi
	#
	# extract from compressed tar
	tar -xvzf CppAD-$AcDate.tar.gz 
	#
	# convert files to dos format
	for file in  cppad-$AcDate/*
	do
		if [ -f $file ]
		then
			unix2dos $file
		fi
	done
	for dir in \
		Adolc \
		CppAD \
		CppAD/local \
		Example \
		Fadbad \
		GetStarted \
		lib \
		omh \
		Speed \
		TestMore
	do
		for file in cppad-$AcDate/$dir/*
		do
			if [ -f $file ]
			then
				unix2dos $file
			fi
		done
	done
	for dir in \
		Dev \
		Doc 
	do
		for file in \
			cppad-$AcDate/$dir/*.xml \
			cppad-$AcDate/$dir/*.htm \
			cppad-$AcDate/$dir/*.js  \
			cppad-$AcDate/$dir/*.xsl 
		do
			unix2dos $file
		done
	done
	#
	# Make sure that dates in certain files are in certain order
	# (necessary because of unix2dos conversion above)
	touch cppad-$AcDate/aclocal.m4
	sleep 2
	touch cppad-$AcDate/CppAD/config.h.in
	sleep 2
	touch cppad-$AcDate/Makefile.in
	touch cppad-$AcDate/*/Makefile.in
	sleep 2
	touch cppad-$AcDate/configure
	#
	# create the dos version CppAD-$AcDate.zip
	zip -r CppAD-$AcDate cppad-$AcDate
	#
	# clean up
	rm -r cppad-$AcDate
	#
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
if [ "$1" = "test" ] || [ "$1" = "all" ]
then
	tar -xvzf CppAD-$AcDate.tar.gz
	cd cppad-$AcDate
	./Build configure test
	make
	if [ "$1" != "all" ]
	then
		exit 0
	fi
fi
if [ "$1" = "all" ]
then
	exit 0
fi
#
if [ "$1" = "" ]
then
	echo "usage: Build option (where valid options are listed below)" 
else
	echo "$1 is not a valid option (valid options are listed below)"
fi
echo "option"
echo "------"
echo "version         update configure.ac and Doc.omh version number"
echo "automake        run aclocal,autoheader,autoconf,automake -> configure"
echo "configure       excludes --with-* except GetStarted and Introduction"
echo "configure test  includes all the possible options except PREFIX_DIR"
echo "make            use make to build all of the requested targets"
echo "omhelp          build all the documentation"
echo "dist            create the distribution files CppAD.*.tar.gz"
echo "dos             create the distribution files CppAD.*.zip"
echo "test            unpack the unix distribution and compiles its tests"
echo
echo "Build all"
echo "This command will execute all the options in the order above"
echo "with the exception that \"configue test\" will be excluded."
echo
echo "Build all test"
echo "This command will execute all the options in the order above"
echo "with the exception that \"configue\" will be excluded."
echo
echo "Build all unix"
echo "This command will execute all the options in the order above"
echo "with the exception that \"configue test\" and \"dos\" will be excluded."
#
exit 1
